<!doctype html>
<html>
    <head>
        <title>AWS CodeWhisperer Logger</title>
        <style>
            /* Core variables */
            :root {
                --aws-orange: #ff9900;
                --aws-blue: #1e88e5;
                --aws-green: #43a047;
                --aws-red: #d32f2f;
                --aws-dark: #232f3e;
                --aws-light: #f5f5f5;
                --aws-magenta: #c2185b;
            }

            /* Base styles */
            body {
                font-family: 'Amazon Ember', Arial, sans-serif;
                margin: 0;
                padding: 0;
                background-color: #fafafa;
                color: #333;
            }

            /* Layout components */
            .header {
                background-color: var(--aws-dark);
                color: white;
                padding: 15px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .controls {
                display: flex;
                gap: 10px;
            }
            .container {
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
            }

            .status-bar {
                background-color: var(--aws-light);
                padding: 10px 20px;
                border-bottom: 1px solid #ddd;
                display: flex;
                justify-content: space-between;
            }

            /* Status indicator */
            .status {
                display: flex;
                align-items: center;
                gap: 5px;
            }
            .status-indicator {
                width: 10px;
                height: 10px;
                border-radius: 50%;
            }
            .connected {
                background-color: var(--aws-green);
            }
            .disconnected {
                background-color: var(--aws-red);
            }

            /* Filters */
            .filters {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
            }
            .filter-btn {
                border: none;
                padding: 5px 10px;
                border-radius: 4px;
                cursor: pointer;
                background-color: var(--aws-light);
            }
            .filter-btn.active {
                background-color: var(--aws-dark);
                color: white;
            }

            /* Log entries */
            .logs-container {
                border: 1px solid #ddd;
                border-radius: 4px;
            }
            .log-entry {
                border-bottom: 1px solid #eee;
                transition: background-color 0.2s;
            }
            .log-entry:hover {
                background-color: rgba(0, 0, 0, 0.02);
            }

            .log-header {
                padding: 10px 15px;
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            /* Log type indicators */
            .log-api .log-header {
                border-left: 4px solid var(--aws-orange);
            }
            .log-completion .log-header {
                border-left: 4px solid var(--aws-blue);
            }
            .log-autoTrigger .log-header {
                border-left: 4px solid var(--aws-magenta);
            }
            .log-edit .log-header {
                border-left: 4px solid var(--aws-green);
            }

            .log-type-badge {
                padding: 3px 8px;
                border-radius: 4px;
                font-size: 0.8rem;
                font-weight: bold;
                color: white;
                background-color: var(--aws-dark);
            }

            .log-meta {
                display: flex;
                gap: 15px;
                font-size: 0.9rem;
                color: #666;
            }

            /* Log content */
            .log-content {
                padding: 0 15px 15px;
                display: none;
            }
            .log-entry.expanded .log-content {
                display: block;
            }
            .log-section {
                margin-bottom: 10px;
            }
            .log-section-title {
                font-weight: bold;
                margin-bottom: 5px;
            }

            /* Status indicators */
            .api-status {
                padding: 2px 6px;
                border-radius: 3px;
                font-weight: bold;
            }
            .api-status-success {
                background-color: rgba(67, 160, 71, 0.2);
                color: var(--aws-green);
            }
            .api-status-error {
                background-color: rgba(211, 47, 47, 0.2);
                color: var(--aws-red);
            }

            /* Code and JSON display */
            .json-viewer,
            .completion-line,
            .api-endpoint,
            .completion-position {
                font-family: monospace;
                background-color: #f8f8f8;
                border-radius: 4px;
                padding: 8px;
                overflow-x: auto;
            }

            /* JSON syntax highlighting */
            .json-key {
                color: var(--aws-dark);
                font-weight: bold;
            }
            .json-string {
                color: var(--aws-green);
            }
            .json-number {
                color: var(--aws-blue);
            }
            .json-boolean {
                color: var(--aws-orange);
            }
            .json-null {
                color: var(--aws-red);
            }

            /* Buttons */
            button {
                background-color: var(--aws-orange);
                border: none;
                color: white;
                padding: 8px 16px;
                cursor: pointer;
                border-radius: 4px;
                font-weight: 500;
                transition: background-color 0.2s;
            }
            button:hover {
                background-color: #ec7211;
            }
            button.secondary {
                background-color: var(--aws-dark);
            }
            button.secondary:hover {
                background-color: #1a242f;
            }

            /* Log group styling */
            .log-group {
                margin-bottom: 20px;
                border: 1px solid #ccc;
                border-radius: 5px;
            }
            .log-group-header {
                padding: 10px;
                background-color: #f0f0f0;
                border-bottom: 1px solid #ccc;
                font-weight: bold;
                display: flex;
                justify-content: space-between;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="controls">
                <button id="clearBtn">Clear Logs</button>
                <button id="reconnectBtn" class="secondary">Reconnect</button>
            </div>
        </div>

        <div class="status-bar">
            <div class="status">
                Status: <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">Disconnected</span>
            </div>
            <div class="log-count">Logs: <span id="logCount">0</span></div>
        </div>

        <div class="container">
            <div class="filters">
                <button class="filter-btn active" data-type="all">All</button>
                <button class="filter-btn" data-type="api">LSP</button>
                <button class="filter-btn" data-type="completion">GenerationCompletions</button>
                <button class="filter-btn" data-type="edit">EditTrigger</button>
                <button class="filter-btn" data-type="autoTrigger">AutoTrigger</button>
            </div>

            <div id="logs" class="logs-container"></div>
        </div>

        <script>
            const logsContainer = document.getElementById('logs')
            const statusIndicator = document.getElementById('statusIndicator')
            const statusText = document.getElementById('statusText')
            const logCountEl = document.getElementById('logCount')
            const clearBtn = document.getElementById('clearBtn')
            const reconnectBtn = document.getElementById('reconnectBtn')
            const filterBtns = document.querySelectorAll('.filter-btn')

            let ws
            let currentFilter = 'all'
            let allLogs = []

            // Set up filter buttons
            filterBtns.forEach((btn) => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach((b) => b.classList.remove('active'))
                    btn.classList.add('active')
                    currentFilter = btn.dataset.type
                    renderLogs()
                })
            })

            function connect() {
                ws = new WebSocket('ws://localhost:3000/ws')

                ws.onopen = () => {
                    console.log('Connected to WebSocket server')
                    statusIndicator.className = 'status-indicator connected'
                    statusText.textContent = 'Connected'

                    // Request all existing logs
                    ws.send(JSON.stringify({ type: 'getAll' }))
                }

                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data)

                    if (message.type === 'log') {
                        addLogEntry(message.data)
                    } else if (message.type === 'clear') {
                        allLogs = []
                        renderLogs()
                    } else if (message.type === 'getAll') {
                        allLogs = message.data
                        renderLogs()
                    }
                }

                ws.onclose = () => {
                    console.log('Disconnected from WebSocket server')
                    statusIndicator.className = 'status-indicator disconnected'
                    statusText.textContent = 'Disconnected'

                    // Try to reconnect after 5 seconds
                    setTimeout(connect, 5000)
                }

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error)
                }
            }

            function addLogEntry(log) {
                // Add to our local array
                allLogs.unshift(log) // Add to beginning
                renderLogs()
            }

            function renderLogs() {
                // Group logs by ID
                const logGroups = {}

                // First, group all logs by their ID
                allLogs.forEach((log) => {
                    if (!logGroups[log.id]) {
                        logGroups[log.id] = []
                    }
                    logGroups[log.id].push(log)
                })

                // Sort groups by the timestamp of the most recent log in each group
                const sortedGroupIds = Object.keys(logGroups).sort((a, b) => {
                    const latestA = Math.max(...logGroups[a].map((log) => new Date(log.timestamp).getTime()))
                    const latestB = Math.max(...logGroups[b].map((log) => new Date(log.timestamp).getTime()))
                    return latestB - latestA // Descending order (newest first)
                })

                // Filter groups based on current filter
                const filteredGroupIds =
                    currentFilter === 'all'
                        ? sortedGroupIds
                        : sortedGroupIds.filter((id) => logGroups[id].some((log) => log.logData.type === currentFilter))

                // Update log count - count unique IDs that match the filter
                logCountEl.textContent = filteredGroupIds.length

                // Clear container
                logsContainer.innerHTML = ''

                // Render log groups
                filteredGroupIds.forEach((groupId) => {
                    const groupLogs = logGroups[groupId]

                    // Sort logs within the group by timestamp (newest first)
                    groupLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))

                    // Create a group container
                    const groupContainer = document.createElement('div')
                    groupContainer.className = 'log-group'

                    // Create group header
                    const groupHeader = document.createElement('div')
                    groupHeader.className = 'log-group-header'

                    // Get the types in this group
                    const types = [...new Set(groupLogs.map((log) => log.logData.type))]
                    const typeLabels = types
                        .map((type) => {
                            let color
                            switch (type) {
                                case 'api':
                                    color = 'var(--aws-orange)'
                                    break
                                case 'completion':
                                    color = 'var(--aws-blue)'
                                    break
                                case 'edit':
                                    color = 'var(--aws-green)'
                                    break
                                default:
                                    color = 'var(--aws-dark)'
                            }
                            return `<span style="background-color: ${color}; color: white; padding: 2px 6px; border-radius: 3px; margin-right: 5px;">${type}</span>`
                        })
                        .join('')

                    const firstLog = groupLogs[0]
                    const latestTime = new Date(firstLog.timestamp).toLocaleTimeString()

                    groupHeader.innerHTML = `
                    <div>
                        EditorState hash: ${groupId.substring(0, 10)}
                    </div>
                    <div>
                        Logs: ${groupLogs.length} | Latest: ${latestTime}
                    </div>
                `

                    groupContainer.appendChild(groupHeader)

                    // Add logs to the group
                    groupLogs.forEach((log) => {
                        // Only include logs that match the current filter
                        if (currentFilter !== 'all' && log.logData.type !== currentFilter) {
                            return
                        }

                        const entry = document.createElement('div')
                        entry.className = `log-entry log-${log.logData.type}`

                        const header = document.createElement('div')
                        header.className = 'log-header'

                        const time = new Date(log.timestamp).toLocaleTimeString()

                        // Create header content based on log type
                        let headerContent = ''
                        let detailContent = ''

                        switch (log.logData.type) {
                            case 'api':
                                const apiData = log.logData.data
                                const statusClass =
                                    apiData.statusCode >= 200 && apiData.statusCode < 300
                                        ? 'api-status-success'
                                        : 'api-status-error'

                                headerContent = `
                                <div>
                                    <span class="log-type-badge">GenerateCompletions</span>
                                    <span class="api-endpoint">${apiData.endpoint}</span>
                                    <span class="api-status ${statusClass}">${apiData.statusCode || 'N/A'}</span>
                                </div>
                                <div class="log-meta">
                                    <span>Time: ${time}</span>
                                    ${apiData.latency ? `<span>Latency: ${apiData.latency}ms</span>` : ''}
                                </div>
                            `

                                detailContent = `
                                <div class="log-section">
                                    <div class="log-section-title">Request</div>
                                    <div class="json-viewer">${formatJSON(apiData.request)}</div>
                                </div>
                                <div class="log-section">
                                    <div class="log-section-title">Response</div>
                                    <div class="json-viewer">${formatJSON(apiData.response)}</div>
                                </div>
                                ${
                                    apiData.error
                                        ? `
                                    <div class="log-section">
                                        <div class="log-section-title">Error</div>
                                        <div class="json-viewer">${apiData.error}</div>
                                    </div>
                                `
                                        : ''
                                }
                                ${
                                    apiData.metadata
                                        ? `
                                    <div class="log-section">
                                        <div class="log-section-title">Metadata</div>
                                        <div class="json-viewer">${formatJSON(apiData.metadata)}</div>
                                    </div>
                                `
                                        : ''
                                }
                            `
                                break

                            case 'completion':
                                const compData = log.logData.data
                                const fileName = compData.textDocument.uri.split('/').pop() || ''

                                headerContent = `
                                <div>
                                    <span class="log-type-badge">LSP</span>
                                    <span class="completion-file">${fileName}</span>
                                    <span class="completion-position">Line ${compData.position.line}:${compData.position.character}</span>
                                </div>
                                <div class="log-meta">
                                    <span>Time: ${time}</span>
                                    ${compData.suggestionCount ? `<span>Suggestions: ${compData.suggestionCount}</span>` : ''}
                                </div>
                            `

                                detailContent = `
                                ${
                                    compData.documentContent?.currentLine
                                        ? `
                                    <div class="log-section">
                                        <div class="log-section-title">Current Line</div>
                                        <div class="completion-line">${escapeHTML(compData.documentContent.currentLine)}</div>
                                    </div>
                                `
                                        : ''
                                }
                                <div class="log-section">
                                    <div class="log-section-title">Document</div>
                                    <div class="json-viewer">${formatJSON(compData.textDocument)}</div>
                                </div>
                                ${
                                    compData.context
                                        ? `
                                    <div class="log-section">
                                        <div class="log-section-title">Context</div>
                                        <div class="json-viewer">${formatJSON(compData.context)}</div>
                                    </div>
                                `
                                        : ''
                                }
                                ${
                                    compData.documentContent
                                        ? `
                                    <div class="log-section">
                                        <div class="log-section-title">Document Content</div>
                                        <div class="json-viewer">${formatJSON(compData.documentContent)}</div>
                                    </div>
                                `
                                        : ''
                                }
                                ${
                                    compData.responseContext
                                        ? `
                                    <div class="log-section">
                                        <div class="log-section-title">Response Context</div>
                                        <div class="json-viewer">${formatJSON(compData.responseContext)}</div>
                                    </div>
                                `
                                        : ''
                                }
                            `
                                break

                            case 'edit':
                                const editData = log.logData.data
                                const triggerClass = editData.shouldTrigger ? 'edit-trigger-yes' : 'edit-trigger-no'

                                headerContent = `
                                <div>
                                    <span class="log-type-badge">Edit AutoTrigger</span>


                                    <span class="api-status ${editData.shouldTrigger ? 'api-status-success' : 'api-status-error'}">
                                        ${editData.shouldTrigger ? 'Triggered' : 'Not Triggered'}

                                    ${editData.filename ? `<span class="completion-file">${editData.filename.split('/').pop()}</span>` : ''}
                                </div>
                                <div class="log-meta">
                                    <span>Time: ${time}</span>
                                    ${editData.language ? `<span>Language: ${editData.language}</span>` : ''}
                                </div>
                            `

                                detailContent = `
                                <div class="log-section">
                                    <div class="log-section-title">Details</div>
                                    <div class="json-viewer">${formatJSON(editData)}</div>
                                </div>
                            `
                                break

                            case 'autoTrigger':
                                const autoTriggerData = log.logData.data

                                headerContent = `
                                <div>
                                    <span class="log-type-badge">Completions AutoTrigger</span>
                                    <span class="api-status ${autoTriggerData.completionsAutoTrigger ? 'api-status-success' : 'api-status-error'}">
                                        ${autoTriggerData.completionsAutoTrigger ? 'Triggered' : 'Not Triggered'}
                                    </span>
                                </div>
                                <div class="log-meta">
                                    <span>Time: ${time}</span>
                                </div>
                            `

                                detailContent = `
                                <div class="log-section">
                                    <div class="log-section-title">Details</div>
                                    <div class="json-viewer">${formatJSON(autoTriggerData)}</div>
                                </div>
                            `
                        }

                        header.innerHTML = headerContent

                        const content = document.createElement('div')
                        content.className = 'log-content'
                        content.innerHTML = detailContent

                        entry.appendChild(header)
                        entry.appendChild(content)

                        // Toggle expanded state on click
                        header.addEventListener('click', () => {
                            entry.classList.toggle('expanded')
                        })

                        groupContainer.appendChild(entry)
                    })

                    logsContainer.appendChild(groupContainer)
                })
            }

            function formatJSON(obj) {
                if (obj === null) return '<span class="json-null">null</span>'
                if (obj === undefined) return '<span class="json-null">undefined</span>'

                try {
                    // For strings that are already JSON
                    if (typeof obj === 'string') {
                        try {
                            obj = JSON.parse(obj)
                        } catch (e) {
                            // Not JSON, keep as string
                        }
                    }

                    const formatted = JSON.stringify(obj, null, 2)
                        .replace(/&/g, '&')
                        .replace(/</g, '<')
                        .replace(/>/g, '>')
                        .replace(
                            /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
                            function (match) {
                                let cls = 'json-number'
                                if (/^"/.test(match)) {
                                    if (/:$/.test(match)) {
                                        cls = 'json-key'
                                        // Remove quotes and colon from key
                                        match = match.replace(/[":]/g, '')
                                    } else {
                                        cls = 'json-string'
                                    }
                                } else if (/true|false/.test(match)) {
                                    cls = 'json-boolean'
                                } else if (/null/.test(match)) {
                                    cls = 'json-null'
                                }
                                return '<span class="' + cls + '">' + match + '</span>'
                            }
                        )

                    return formatted
                } catch (e) {
                    return String(obj).replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>')
                }
            }

            function escapeHTML(str) {
                return String(str)
                    .replace(/&/g, '&')
                    .replace(/</g, '<')
                    .replace(/>/g, '>')
                    .replace(/"/g, '"')
                    .replace(/'/g, '&#39;')
            }

            clearBtn.addEventListener('click', () => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'clear' }))
                }
            })

            reconnectBtn.addEventListener('click', () => {
                if (ws) {
                    ws.close()
                }
                connect()
            })

            // Initial connection
            connect()
        </script>
    </body>
</html>
