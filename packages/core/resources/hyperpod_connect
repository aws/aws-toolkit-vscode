#!/usr/bin/env bash

# HyperPod Connection Script
# 
# This script establishes a connection to an AWS SageMaker HyperPod instance using AWS Systems Manager (SSM).
# HyperPod is AWS's managed service for distributed machine learning training at scale.
#
# OVERVIEW:
# The script always gets fresh credentials from the reconnection manager and uses them to establish
# a secure session tunnel to a HyperPod compute instance.
#
# OPTIONAL ENVIRONMENT VARIABLES:
#   LOG_FILE_LOCATION   - Path to log file (default: /tmp/hyperpod_connect.log)
#   DEBUG_LOG           - Enable debug logging (default: 0)
#
# USAGE:
#   ./hyperpod_connect hp_demo1
#
# SECURITY NOTE:
# This script handles sensitive authentication tokens. Ensure proper file permissions
# and avoid logging sensitive values in production environments. 
set -x
set -e
set -u

_DATE_CMD=true

if command > /dev/null 2>&1 -v date; then
    _DATE_CMD=date
elif command > /dev/null 2>&1 -v /bin/date; then
    _DATE_CMD=/bin/date
fi

_log() {
    echo "$("$_DATE_CMD" '+%Y/%m/%d %H:%M:%S')" "$@" >> "${LOG_FILE_LOCATION}" 2>&1
}

_require_nolog() {
    if [ -z "${1:-}" ] || [ -z "${2:-}" ]; then
        _log "error: missing required arg: $1"
        exit 1
    fi
}

_require() {
    _require_nolog "$@"
    _log "$1=$2"
}

_url_encode() {
    python3 -c "import sys, urllib.parse; print(urllib.parse.quote(sys.argv[1]))" "$1"
}

_resolve_connection_key() {
    local DEVSPACE_NAME=$1
    local PROFILES_FILE="$HOME/.aws/.hyperpod-space-profiles"
    
    [ ! -f "$PROFILES_FILE" ] && echo "$DEVSPACE_NAME" && return
    
    python3 -c "
import json
try:
    with open('$PROFILES_FILE', 'r') as f:
        profiles = json.load(f)
    matches = sorted([k for k in profiles.keys() if k.endswith(':$DEVSPACE_NAME')])
    print(matches[0] if matches else '$DEVSPACE_NAME')
except:
    print('$DEVSPACE_NAME')
" 2>/dev/null
}

_hyperpod() {
    # Function inputs
    local AWS_SSM_CLI=$1
    local AWS_REGION=$2
    local STREAM_URL=$3
    local TOKEN=$4
    local SESSION_ID=$5

    exec "$AWS_SSM_CLI" "{\"streamUrl\":\"$STREAM_URL\",\"tokenValue\":\"$TOKEN\",\"sessionId\":\"$SESSION_ID\"}" "$AWS_REGION" "StartSession"
}

_get_fresh_credentials() {
    local CONNECTION_KEY=$1
    
    _log "Getting fresh credentials for connection key: $CONNECTION_KEY"
    
    # Read server info to get port
    if [ -z "$SAGEMAKER_LOCAL_SERVER_FILE_PATH" ]; then
        _log "Error: SAGEMAKER_LOCAL_SERVER_FILE_PATH environment variable is not set"
        exit 1
    fi
    
    if [ ! -f "$SAGEMAKER_LOCAL_SERVER_FILE_PATH" ]; then
        _log "Error: Server info file not found: $SAGEMAKER_LOCAL_SERVER_FILE_PATH"
        exit 1
    fi
    
    local PORT=$(jq -r '.port' "$SAGEMAKER_LOCAL_SERVER_FILE_PATH")
    if [ -z "$PORT" ] || [ "$PORT" == "null" ]; then
        _log "Error: 'port' field is missing or invalid in $SAGEMAKER_LOCAL_SERVER_FILE_PATH"
        exit 1
    fi
    
    # Call API to get fresh credentials using the determined connection key
    local API_URL
    if [[ "$CONNECTION_KEY" =~ ^[^:]+:[^:]+:[^:]+$ ]]; then
        # Use full connection key for precise lookup (preferred)
        API_URL="http://localhost:$PORT/get_hyperpod_session?connection_key=$(_url_encode "$CONNECTION_KEY")"
    elif [ -n "$CLUSTER_NAME" ] && [ -n "$NAMESPACE" ]; then
        # Use individual parameters if available
        API_URL="http://localhost:$PORT/get_hyperpod_session?devspace_name=$(_url_encode "$DEVSPACE_NAME")&namespace=$(_url_encode "$NAMESPACE")&cluster_name=$(_url_encode "$CLUSTER_NAME")"
    else
        # Fallback for legacy format
        API_URL="http://localhost:$PORT/get_hyperpod_session?connection_key=$(_url_encode "$CONNECTION_KEY")"
    fi
    API_RESPONSE=$(curl -s "$API_URL")
    
    if [ $? -ne 0 ] || [ -z "$API_RESPONSE" ]; then
        _log "Error: Failed to get credentials from API"
        exit 1
    fi
    
    # Parse JSON once and check for error response
    read -r STATUS ERROR_MSG CONNECTION_URL < <(echo "$API_RESPONSE" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('status', 'success'), data.get('message', ''), data.get('connection', {}).get('url', ''))" 2>/dev/null) || {
        _log "Error: Failed to parse API response JSON"
        exit 1
    }
    if [ "$STATUS" = "error" ]; then
        _log "Error from API: ${ERROR_MSG:-Unknown error}"
        exit 1
    fi
    
    _log "Fresh credentials obtained from API"
}

_main() {
    # Set defaults for missing environment variables
    DEBUG_LOG=${DEBUG_LOG:-0}
    LOG_FILE_LOCATION=${LOG_FILE_LOCATION:-/tmp/hyperpod_connect.log}

    if [ $# -ne 1 ]; then
        _log "Usage: $0 hp_<devspace_name>"
        exit 1
    fi

    # Extract devspace name, cluster name, and namespace from hostname
    # New format: hp_{cluster_name}_{namespace}_{space_name}_{region}_{account_id}
    # Old format: hp_{devspace} (for backward compatibility)
    if [[ "$1" =~ ^hp_([^_]+)_([^_]+)_([^_]+)_([^_]+)_([^_]+)$ ]]; then
        # New format: cluster_namespace_space_region_account
        CLUSTER_NAME="${BASH_REMATCH[1]}"
        NAMESPACE="${BASH_REMATCH[2]}"
        DEVSPACE_NAME="${BASH_REMATCH[3]}"
        # Construct the expected connection key (cluster:namespace:devspace)
        CONNECTION_KEY="${CLUSTER_NAME}:${NAMESPACE}:${DEVSPACE_NAME}"
    else
        # Old format or fallback - extract devspace name only
        DEVSPACE_NAME=$(echo "$1" | sed 's/hp_//')
        CLUSTER_NAME=""
        NAMESPACE=""
        CONNECTION_KEY=""
    fi
    
    # For new format, we already have the connection key constructed from hostname
    # For old format, look up the connection key from the hyperpod profiles file
    [ -z "$CONNECTION_KEY" ] && CONNECTION_KEY=$(_resolve_connection_key "$DEVSPACE_NAME")
    
    if [ -z "$CONNECTION_KEY" ]; then
        _log "Error: Could not determine connection key for devspace: $DEVSPACE_NAME"
        exit 1
    fi
    
    _log "=============================================================================="
    _log "Connecting to HyperPod devspace: $DEVSPACE_NAME (connection key: $CONNECTION_KEY)"
    
    # Always get fresh credentials (CONNECTION_URL is set by _get_fresh_credentials)
    _get_fresh_credentials "$CONNECTION_KEY"
    
    if [[ "$CONNECTION_URL" =~ ^wss:// ]]; then
        # Presigned URL format - extract session ID from path and token from cell-number param
        SESSION_ID=$(echo "$CONNECTION_URL" | python3 -c "import sys, urllib.parse; url=sys.stdin.read().strip(); path=urllib.parse.urlparse(url).path; session_id=path.split('/')[-1] if path else ''; print(session_id)" 2>/dev/null)
        TOKEN=$(echo "$CONNECTION_URL" | python3 -c "import sys, urllib.parse; url=sys.stdin.read().strip(); params=urllib.parse.parse_qs(urllib.parse.urlparse(url).query); print(params.get('cell-number', [''])[0])" 2>/dev/null)
        STREAM_URL="$CONNECTION_URL"
    else
        # Kubectl format - extract from query params
        SESSION_ID=$(echo "$CONNECTION_URL" | python3 -c "import sys, urllib.parse; url=sys.stdin.read().strip(); params=urllib.parse.parse_qs(urllib.parse.urlparse(url).query); print(params.get('sessionId', [''])[0])" 2>/dev/null)
        TOKEN=$(echo "$CONNECTION_URL" | python3 -c "import sys, urllib.parse; url=sys.stdin.read().strip(); params=urllib.parse.parse_qs(urllib.parse.urlparse(url).query); print(params.get('sessionToken', [''])[0])" 2>/dev/null)
        STREAM_URL=$(echo "$CONNECTION_URL" | python3 -c "import sys, urllib.parse; url=sys.stdin.read().strip(); params=urllib.parse.parse_qs(urllib.parse.urlparse(url).query); print(params.get('streamUrl', [''])[0])" 2>/dev/null)
    fi
    
    # Extract region from stream URL
    AWS_REGION=$(echo "$STREAM_URL" | grep -o '\.[a-z0-9-]*\.amazonaws\.com' | sed 's/^\.//;s/\.amazonaws\.com$//')
    AWS_SSM_CLI="${AWS_SSM_CLI:-session-manager-plugin}"
    
    # Validate required parameters (SESSION_ID, STREAM_URL, TOKEN are fetched from API, not validated here)
    _require AWS_REGION "${AWS_REGION}"
    _require AWS_SSM_CLI "${AWS_SSM_CLI}"
    
    if [ -z "${SESSION_ID}" ] || [ -z "${STREAM_URL}" ] || [ -z "${TOKEN}" ]; then
        _log "Error: Failed to retrieve valid session credentials from API"
        exit 1
    fi

    _hyperpod "$AWS_SSM_CLI" "$AWS_REGION" "$STREAM_URL" "$TOKEN" "$SESSION_ID"
}

_main "$@"
