#!/usr/bin/env bash

# HyperPod Connection Script
# 
# This script establishes a connection to an AWS SageMaker HyperPod instance using AWS Systems Manager (SSM).
# HyperPod is AWS's managed service for distributed machine learning training at scale.
#
# OVERVIEW:
# The script always gets fresh credentials from the reconnection manager and uses them to establish
# a secure session tunnel to a HyperPod compute instance.
#
# OPTIONAL ENVIRONMENT VARIABLES:
#   LOG_FILE_LOCATION   - Path to log file (default: /tmp/hyperpod_connect.log)
#   DEBUG_LOG           - Enable debug logging (default: 0)
#
# USAGE:
#   ./hyperpod_connect hp_demo1
#
# SECURITY NOTE:
# This script handles sensitive authentication tokens. Ensure proper file permissions
# and avoid logging sensitive values in production environments. 
set -x
set -e
set -u

_DATE_CMD=true

if command > /dev/null 2>&1 -v date; then
    _DATE_CMD=date
elif command > /dev/null 2>&1 -v /bin/date; then
    _DATE_CMD=/bin/date
fi

_log() {
    echo "$("$_DATE_CMD" '+%Y/%m/%d %H:%M:%S')" "$@" >> "${LOG_FILE_LOCATION}" 2>&1
}

_require_nolog() {
    if [ -z "${1:-}" ] || [ -z "${2:-}" ]; then
        _log "error: missing required arg: $1"
        exit 1
    fi
}

_require() {
    _require_nolog "$@"
    _log "$1=$2"
}

_hyperpod() {
    # Function inputs
    local AWS_SSM_CLI=$1
    local AWS_REGION=$2
    local STREAM_URL=$3
    local TOKEN=$4
    local SESSION_ID=$5

    exec "$AWS_SSM_CLI" "{\"streamUrl\":\"$STREAM_URL\",\"tokenValue\":\"$TOKEN\",\"sessionId\":\"$SESSION_ID\"}" "$AWS_REGION" "StartSession"
}

_get_fresh_credentials() {
    local DEVSPACE_NAME=$1
    
    _log "Getting fresh credentials for $DEVSPACE_NAME"
    
    # Read server info to get port
    local SERVER_INFO_FILE="$HOME/Library/Application Support/Code/User/globalStorage/amazonwebservices.aws-toolkit-vscode/sagemaker-local-server-info.json"
    if [ ! -f "$SERVER_INFO_FILE" ]; then
        _log "Error: Server info file not found: $SERVER_INFO_FILE"
        exit 1
    fi
    
    local PORT=$(cat "$SERVER_INFO_FILE" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['port'])" 2>/dev/null)
    if [ -z "$PORT" ]; then
        _log "Error: Could not extract port from server info file"
        exit 1
    fi
    
    # Call API to get fresh credentials
    local API_URL="http://localhost:$PORT/get_hyperpod_session?devspace_name=$DEVSPACE_NAME"
    API_RESPONSE=$(curl -s "$API_URL")
    
    if [ $? -ne 0 ] || [ -z "$API_RESPONSE" ]; then
        _log "Error: Failed to get credentials from API"
        exit 1
    fi
    
    _log "Fresh credentials obtained from API"
}

_main() {
    # Set defaults for missing environment variables
    DEBUG_LOG=${DEBUG_LOG:-0}
    LOG_FILE_LOCATION=${LOG_FILE_LOCATION:-/tmp/hyperpod_connect.log}

    if [ $# -ne 1 ]; then
        _log "Usage: $0 hp_<devspace_name>"
        exit 1
    fi

    DEVSPACE_NAME=$(echo "$1" | sed 's/hp_//')
    
    _log "=============================================================================="
    _log "Connecting to HyperPod devspace: $DEVSPACE_NAME"
    
    # Always get fresh credentials
    _get_fresh_credentials "$DEVSPACE_NAME"
    
    # Parse credentials directly from API response JSON - handle URL encoding properly
    SESSION_ID=$(echo "$API_RESPONSE" | python3 -c "import sys, json, urllib.parse, html; data=json.load(sys.stdin); url=html.unescape(data['connection']['url']); print(urllib.parse.parse_qs(urllib.parse.urlparse(url).query)['sessionId'][0])" 2>/dev/null)
    TOKEN=$(echo "$API_RESPONSE" | python3 -c "import sys, json, urllib.parse, html; data=json.load(sys.stdin); url=html.unescape(data['connection']['url']); token=urllib.parse.parse_qs(urllib.parse.urlparse(url).query)['sessionToken'][0]; print(token.replace(' ', '+'))" 2>/dev/null)
    STREAM_URL=$(echo "$API_RESPONSE" | python3 -c "import sys, json, urllib.parse, html; data=json.load(sys.stdin); url=html.unescape(data['connection']['url']); parsed=urllib.parse.parse_qs(urllib.parse.urlparse(url).query); stream_url=urllib.parse.unquote(parsed['streamUrl'][0]); cell_number=parsed.get('cell-number', [''])[0]; final_url=stream_url + ('&cell-number=' + urllib.parse.unquote(cell_number) if cell_number else ''); print(final_url.replace(' ', '+'))" 2>/dev/null)
    
    # Extract region from stream URL
    AWS_REGION=$(echo "$STREAM_URL" | grep -o '\.[a-z0-9-]*\.amazonaws\.com' | sed 's/^\.//;s/\.amazonaws\.com$//')
    AWS_SSM_CLI="${AWS_SSM_CLI:-session-manager-plugin}"
    
    # Validate all required parameters
    _require AWS_REGION "${AWS_REGION}"
    _require AWS_SSM_CLI "${AWS_SSM_CLI}"
    _require SESSION_ID "${SESSION_ID}"
    _require_nolog STREAM_URL "${STREAM_URL}"
    _require_nolog TOKEN "${TOKEN}"

    _hyperpod "$AWS_SSM_CLI" "$AWS_REGION" "$STREAM_URL" "$TOKEN" "$SESSION_ID"
}

_main "$@"